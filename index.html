<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bowler Chart Tracker - Scenthound</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: #f8f8f8;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 0;
            box-shadow: none;
            max-width: 100%;
            margin: 0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 40px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 400;
            margin-top: 5px;
        }

        .btn {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Poppins', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 160, 220, 0.3);
        }

        .btn-secondary {
            background: #FF6B35;
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .btn-cancel {
            background: #999;
        }

        .btn-cancel:hover {
            background: #777;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .form-box {
            background: #f0f9ff;
            border-left: 5px solid #00A0DC;
            padding: 30px;
            margin: 30px 0;
            border-radius: 8px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #0077B6;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #00A0DC;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            border: 2px solid #00A0DC;
            background: white;
            color: #00A0DC;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
        }

        .tab:hover {
            background: #e6f7ff;
        }

        .tab.active {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
            border-color: #0077B6;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table thead {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
        }

        .data-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table th.text-right {
            text-align: right;
        }

        .data-table th.highlight {
            background: #0077B6;
        }

        .data-table th.conversion {
            background: #FF6B35;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table td.text-right {
            text-align: right;
        }

        .data-table tbody tr:hover {
            background: #f0f9ff;
        }

        .data-table td.highlight {
            background: #f0f9ff;
            font-weight: 600;
        }

        .data-table td.conversion {
            background: #fff8f0;
            font-weight: 600;
            color: #FF6B35;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .edit-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background: #e0a800;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .info-note {
            background: #fff8f0;
            border-left: 4px solid #FF6B35;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 0.95em;
        }

        .info-note strong {
            color: #FF6B35;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 0.85em;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase - Load before using Firebase services -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyCgQV7FiS6V28Yy-bdCNik2tHdmrcz0L6E",
        authDomain: "leash-bowler.firebaseapp.com",
        projectId: "leash-bowler",
        storageBucket: "leash-bowler.firebasestorage.app",
        messagingSenderId: "363242291452",
        appId: "1:363242291452:web:2b5f6c007e129fd1e45779"
      };
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      
      // Make Firebase available globally
      window.firebaseDB = db;
      window.firestoreCollection = collection;
      window.firestoreGetDocs = getDocs;
      window.firestoreAddDoc = addDoc;
      window.firestoreDeleteDoc = deleteDoc;
      window.firestoreDoc = doc;
      window.firestoreOnSnapshot = onSnapshot;
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const BowlerTracker = () => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('daily');
            const [locationFilter, setLocationFilter] = useState('All Scenters');
            const [chartType, setChartType] = useState('line');
            const [selectedMetrics, setSelectedMetrics] = useState(['newLeads', 'activeTrialLeads']);
            const [chartTimeframe, setChartTimeframe] = useState('daily');
            const [editingEntry, setEditingEntry] = useState(null);
            const [chartDateFrom, setChartDateFrom] = useState('');
            const [chartDateTo, setChartDateTo] = useState('');
            const [deletedEntries, setDeletedEntries] = useState([]);
            const [showUndoToast, setShowUndoToast] = useState(false);
            const [userName, setUserName] = useState(() => localStorage.getItem('bowlerUserName') || '');
            const [trendPeriod, setTrendPeriod] = useState('week');
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);
            const [currentEntry, setCurrentEntry] = useState({
                date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
                location: 'Cedar Mill',
                newLeads: 0,
                activeTrialLeads: 0,
                texted: 0,
                called: 0,
                bookedPhone: 0,
                bookedText: 0,
                comments: '',
                enteredBy: ''
            });
            
            const locations = ['Cedar Mill', 'Tigard', 'Hillsboro', 'Sherwood'];

            useEffect(() => {
                // Wait for Firebase to be ready
                const checkFirebase = setInterval(() => {
                    if (window.firebaseDB) {
                        clearInterval(checkFirebase);
                        loadEntriesFromFirebase();
                    }
                }, 100);
                
                return () => clearInterval(checkFirebase);
            }, []);

            const loadEntriesFromFirebase = async () => {
                try {
                    const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                    const snapshot = await window.firestoreGetDocs(entriesCol);
                    const entriesData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setEntries(entriesData.sort((a, b) => new Date(b.date) - new Date(a.date)));
                } catch (error) {
                    console.error('Error loading entries:', error);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (!loading) {
                    // No longer need to save to localStorage
                    // Data is automatically saved to Firebase when added
                }
            }, [entries, loading]);

            const handleInputChange = (field, value) => {
                setCurrentEntry(prev => ({
                    ...prev,
                    [field]: field === 'comments' || field === 'enteredBy' ? value : (parseInt(value) || 0)
                }));
            };

            const addEntry = async () => {
                try {
                    const entryToSave = {
                        ...currentEntry,
                        enteredBy: currentEntry.enteredBy || userName
                    };
                    
                    if (editingEntry) {
                        // Update existing entry
                        const docRef = window.firestoreDoc(window.firebaseDB, 'entries', editingEntry.id);
                        await window.firestoreDeleteDoc(docRef);
                        const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                        await window.firestoreAddDoc(entriesCol, entryToSave);
                        setEditingEntry(null);
                    } else {
                        // Add new entry
                        const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                        await window.firestoreAddDoc(entriesCol, entryToSave);
                    }
                    await loadEntriesFromFirebase();
                    setCurrentEntry({
                        date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
                        location: 'Cedar Mill',
                        newLeads: 0,
                        activeTrialLeads: 0,
                        texted: 0,
                        called: 0,
                        bookedPhone: 0,
                        bookedText: 0,
                        comments: '',
                        enteredBy: userName
                    });
                    setShowForm(false);
                } catch (error) {
                    console.error('Error saving entry:', error);
                    alert('Error saving entry. Please try again.');
                }
            };

            const deleteEntry = async (index) => {
                try {
                    const entry = getFilteredEntries()[index];
                    // Store for undo
                    setDeletedEntries(prev => [...prev, entry]);
                    setShowUndoToast(true);
                    
                    // Auto-hide toast after 10 seconds
                    setTimeout(() => {
                        setShowUndoToast(false);
                        setDeletedEntries(prev => prev.filter(e => e.id !== entry.id));
                    }, 10000);
                    
                    const docRef = window.firestoreDoc(window.firebaseDB, 'entries', entry.id);
                    await window.firestoreDeleteDoc(docRef);
                    await loadEntriesFromFirebase();
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    alert('Error deleting entry. Please try again.');
                }
            };

            const undoDelete = async () => {
                if (deletedEntries.length === 0) return;
                
                try {
                    const lastDeleted = deletedEntries[deletedEntries.length - 1];
                    const { id, ...entryData } = lastDeleted;
                    
                    const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                    await window.firestoreAddDoc(entriesCol, entryData);
                    
                    setDeletedEntries(prev => prev.slice(0, -1));
                    if (deletedEntries.length <= 1) {
                        setShowUndoToast(false);
                    }
                    await loadEntriesFromFirebase();
                } catch (error) {
                    console.error('Error restoring entry:', error);
                    alert('Error restoring entry. Please try again.');
                }
            };

            const editEntry = (index) => {
                const entry = getFilteredEntries()[index];
                setCurrentEntry({
                    date: entry.date,
                    location: entry.location,
                    newLeads: entry.newLeads,
                    activeTrialLeads: entry.activeTrialLeads,
                    texted: entry.texted,
                    called: entry.called,
                    bookedPhone: entry.bookedPhone,
                    bookedText: entry.bookedText,
                    comments: entry.comments || '',
                    enteredBy: entry.enteredBy || ''
                });
                setEditingEntry(entry);
                setShowForm(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setEditingEntry(null);
                setCurrentEntry({
                    date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
                    location: 'Cedar Mill',
                    newLeads: 0,
                    activeTrialLeads: 0,
                    texted: 0,
                    called: 0,
                    bookedPhone: 0,
                    bookedText: 0,
                    comments: '',
                    enteredBy: userName
                });
                setShowForm(false);
            };

            const getWeekNumber = (dateStr) => {
                // Parse date string as local time, not UTC
                const parts = dateStr.split('-');
                const d = new Date(parts[0], parts[1] - 1, parts[2]);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            const getMonthYear = (dateStr) => {
                // Parse date string as local time, not UTC
                const parts = dateStr.split('-');
                return `${parts[0]}-${parts[1]}`;
            };

            const getYearFromDate = (dateStr) => {
                // Parse date string as local time, not UTC
                const parts = dateStr.split('-');
                return parts[0];
            };

            const calculateTotals = (entriesSubset) => {
                return entriesSubset.reduce((acc, entry) => ({
                    newLeads: acc.newLeads + entry.newLeads,
                    activeTrialLeads: acc.activeTrialLeads + entry.activeTrialLeads,
                    texted: acc.texted + entry.texted,
                    called: acc.called + entry.called,
                    bookedPhone: acc.bookedPhone + entry.bookedPhone,
                    bookedText: acc.bookedText + entry.bookedText,
                    totalContacted: acc.totalContacted + entry.texted + entry.called,
                    totalBooked: acc.totalBooked + entry.bookedPhone + entry.bookedText
                }), {
                    newLeads: 0,
                    activeTrialLeads: 0,
                    texted: 0,
                    called: 0,
                    bookedPhone: 0,
                    bookedText: 0,
                    totalContacted: 0,
                    totalBooked: 0
                });
            };

            // Trend calculation - compare current period to previous period
            const calculateTrends = () => {
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                
                if (filteredEntries.length === 0) return null;
                
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                
                let currentPeriodStart, previousPeriodStart, previousPeriodEnd;
                
                if (trendPeriod === 'week') {
                    // This Week vs Last Week
                    currentPeriodStart = new Date(today);
                    currentPeriodStart.setDate(today.getDate() - today.getDay());
                    currentPeriodStart.setHours(0, 0, 0, 0);
                    
                    previousPeriodEnd = new Date(currentPeriodStart);
                    previousPeriodEnd.setMilliseconds(-1);
                    
                    previousPeriodStart = new Date(currentPeriodStart);
                    previousPeriodStart.setDate(previousPeriodStart.getDate() - 7);
                } else if (trendPeriod === 'month') {
                    // This Month vs Last Month
                    currentPeriodStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    previousPeriodEnd = new Date(currentPeriodStart);
                    previousPeriodEnd.setMilliseconds(-1);
                    
                    previousPeriodStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                } else if (trendPeriod === 'last7') {
                    // Last 7 Days vs Previous 7 Days
                    currentPeriodStart = new Date(today);
                    currentPeriodStart.setDate(today.getDate() - 6);
                    currentPeriodStart.setHours(0, 0, 0, 0);
                    
                    previousPeriodEnd = new Date(currentPeriodStart);
                    previousPeriodEnd.setMilliseconds(-1);
                    
                    previousPeriodStart = new Date(currentPeriodStart);
                    previousPeriodStart.setDate(previousPeriodStart.getDate() - 7);
                } else if (trendPeriod === 'last30') {
                    // Last 30 Days vs Previous 30 Days
                    currentPeriodStart = new Date(today);
                    currentPeriodStart.setDate(today.getDate() - 29);
                    currentPeriodStart.setHours(0, 0, 0, 0);
                    
                    previousPeriodEnd = new Date(currentPeriodStart);
                    previousPeriodEnd.setMilliseconds(-1);
                    
                    previousPeriodStart = new Date(currentPeriodStart);
                    previousPeriodStart.setDate(previousPeriodStart.getDate() - 30);
                }
                
                const currentPeriodEntries = filteredEntries.filter(e => {
                    const parts = e.date.split('-');
                    const d = new Date(parts[0], parts[1] - 1, parts[2]);
                    return d >= currentPeriodStart && d <= today;
                });
                
                const previousPeriodEntries = filteredEntries.filter(e => {
                    const parts = e.date.split('-');
                    const d = new Date(parts[0], parts[1] - 1, parts[2]);
                    return d >= previousPeriodStart && d <= previousPeriodEnd;
                });
                
                const currentTotals = calculateTotals(currentPeriodEntries);
                const previousTotals = calculateTotals(previousPeriodEntries);
                
                // Calculate conversion rate (Total Booked / New Leads)
                const currentConversion = currentTotals.newLeads > 0 
                    ? (currentTotals.totalBooked / currentTotals.newLeads) * 100 
                    : 0;
                const previousConversion = previousTotals.newLeads > 0 
                    ? (previousTotals.totalBooked / previousTotals.newLeads) * 100 
                    : 0;
                
                // Calculate contact rate (Total Contacted / (New Leads + Active Trial))
                const currentContactRate = (currentTotals.newLeads + currentTotals.activeTrialLeads) > 0
                    ? (currentTotals.totalContacted / (currentTotals.newLeads + currentTotals.activeTrialLeads)) * 100
                    : 0;
                const previousContactRate = (previousTotals.newLeads + previousTotals.activeTrialLeads) > 0
                    ? (previousTotals.totalContacted / (previousTotals.newLeads + previousTotals.activeTrialLeads)) * 100
                    : 0;
                
                const getTrend = (current, previous) => {
                    if (previous === 0) return current > 0 ? 'up' : 'neutral';
                    const change = ((current - previous) / previous) * 100;
                    if (change > 5) return 'up';
                    if (change < -5) return 'down';
                    return 'neutral';
                };
                
                const getTrendForRate = (current, previous) => {
                    const diff = current - previous;
                    if (diff > 2) return 'up';
                    if (diff < -2) return 'down';
                    return 'neutral';
                };
                
                const getChange = (current, previous) => {
                    if (previous === 0) return current > 0 ? '+' + current : '0';
                    const change = ((current - previous) / previous) * 100;
                    return (change >= 0 ? '+' : '') + change.toFixed(0) + '%';
                };
                
                const getChangeForRate = (current, previous) => {
                    const diff = current - previous;
                    return (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'pts';
                };
                
                return {
                    newLeads: { trend: getTrend(currentTotals.newLeads, previousTotals.newLeads), change: getChange(currentTotals.newLeads, previousTotals.newLeads), current: currentTotals.newLeads },
                    activeTrialLeads: { trend: getTrend(currentTotals.activeTrialLeads, previousTotals.activeTrialLeads), change: getChange(currentTotals.activeTrialLeads, previousTotals.activeTrialLeads), current: currentTotals.activeTrialLeads },
                    totalContacted: { trend: getTrend(currentTotals.totalContacted, previousTotals.totalContacted), change: getChange(currentTotals.totalContacted, previousTotals.totalContacted), current: currentTotals.totalContacted },
                    totalBooked: { trend: getTrend(currentTotals.totalBooked, previousTotals.totalBooked), change: getChange(currentTotals.totalBooked, previousTotals.totalBooked), current: currentTotals.totalBooked },
                    conversionRate: { trend: getTrendForRate(currentConversion, previousConversion), change: getChangeForRate(currentConversion, previousConversion), current: currentConversion.toFixed(1) },
                    contactRate: { trend: getTrendForRate(currentContactRate, previousContactRate), change: getChangeForRate(currentContactRate, previousContactRate), current: currentContactRate.toFixed(1) }
                };
            };
            
            const getTrendPeriodLabel = () => {
                switch(trendPeriod) {
                    case 'week': return 'This Week vs Last Week';
                    case 'month': return 'This Month vs Last Month';
                    case 'last7': return 'Last 7 Days vs Previous 7 Days';
                    case 'last30': return 'Last 30 Days vs Previous 30 Days';
                    default: return '';
                }
            };

            const TrendIndicator = ({ trend, change }) => {
                const colors = { up: '#22c55e', down: '#ef4444', neutral: '#6b7280' };
                const arrows = { up: '‚Üë', down: '‚Üì', neutral: '‚Üí' };
                return (
                    <span style={{ color: colors[trend], fontWeight: 600, marginLeft: '8px', fontSize: '0.85em' }}>
                        {arrows[trend]} {change}
                    </span>
                );
            };

            // PDF Report Generation
            const generatePDFReport = (reportType) => {
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                
                const today = new Date();
                let reportTitle, reportData, periodLabel;
                
                if (reportType === 'weekly') {
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    
                    reportData = filteredEntries.filter(e => {
                        const d = new Date(e.date);
                        return d >= startOfWeek && d <= endOfWeek;
                    });
                    periodLabel = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
                    reportTitle = 'Weekly Performance Report';
                } else {
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    
                    reportData = filteredEntries.filter(e => {
                        const d = new Date(e.date);
                        return d >= startOfMonth && d <= endOfMonth;
                    });
                    periodLabel = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    reportTitle = 'Monthly Performance Report';
                }
                
                const totals = calculateTotals(reportData);
                const conversionRate = totals.newLeads > 0 
                    ? ((totals.totalBooked / totals.newLeads) * 100).toFixed(1) 
                    : 0;
                
                const contactRate = (totals.newLeads + totals.activeTrialLeads) > 0
                    ? ((totals.totalContacted / (totals.newLeads + totals.activeTrialLeads)) * 100).toFixed(1)
                    : 0;
                
                // Create PDF using browser print
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${reportTitle} - Scenthound</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
                            .header { text-align: center; margin-bottom: 40px; }
                            .header h1 { color: #0077B6; margin: 0; }
                            .header .subtitle { color: #666; margin-top: 10px; }
                            .period { background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 30px; }
                            .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                            .stat-box { background: #f8f8f8; padding: 20px; border-radius: 8px; text-align: center; }
                            .stat-box .value { font-size: 2em; font-weight: bold; color: #0077B6; }
                            .stat-box .label { color: #666; font-size: 0.9em; margin-top: 5px; }
                            .highlight { background: #0077B6; color: white; }
                            .highlight .value { color: white; }
                            .highlight .label { color: rgba(255,255,255,0.9); }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th { background: #0077B6; color: white; padding: 12px; text-align: left; }
                            td { padding: 10px 12px; border-bottom: 1px solid #e0e0e0; }
                            tr:nth-child(even) { background: #f8f8f8; }
                            .footer { text-align: center; margin-top: 40px; color: #666; font-size: 0.9em; }
                            @media print { body { padding: 20px; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üêæ SCENTHOUND</h1>
                            <div class="subtitle">${reportTitle}</div>
                        </div>
                        
                        <div class="period">
                            <strong>Location:</strong> ${locationFilter} &nbsp;&nbsp;|&nbsp;&nbsp; 
                            <strong>Period:</strong> ${periodLabel}
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="value">${totals.newLeads}</div>
                                <div class="label">New Leads</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${totals.activeTrialLeads}</div>
                                <div class="label">Active Trial Leads</div>
                            </div>
                            <div class="stat-box highlight">
                                <div class="value">${totals.totalContacted}</div>
                                <div class="label">Total Contacted</div>
                            </div>
                            <div class="stat-box highlight">
                                <div class="value">${totals.totalBooked}</div>
                                <div class="label">Total Booked</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="value">${totals.texted}</div>
                                <div class="label">Texted</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${totals.called}</div>
                                <div class="label">Called</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${totals.bookedPhone}</div>
                                <div class="label">Booked (Phone)</div>
                            </div>
                            <div class="stat-box">
                                <div class="value">${totals.bookedText}</div>
                                <div class="label">Booked (Text)</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div class="stat-box" style="border: 3px solid #22c55e;">
                                <div class="value" style="color: #22c55e;">${conversionRate}%</div>
                                <div class="label">Conversion Rate</div>
                                <div class="label" style="font-size: 0.8em; color: #999;">Total Booked / New Leads</div>
                            </div>
                            <div class="stat-box" style="border: 3px solid #8b5cf6;">
                                <div class="value" style="color: #8b5cf6;">${contactRate}%</div>
                                <div class="label">Contact Rate</div>
                                <div class="label" style="font-size: 0.8em; color: #999;">Total Contacted / All Leads</div>
                            </div>
                        </div>
                        
                        <h3>Daily Breakdown</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Location</th>
                                    <th>New Leads</th>
                                    <th>Contacted</th>
                                    <th>Booked</th>
                                    <th>Entered By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.sort((a, b) => new Date(a.date) - new Date(b.date)).map(entry => `
                                    <tr>
                                        <td>${entry.date}</td>
                                        <td>${entry.location}</td>
                                        <td>${entry.newLeads}</td>
                                        <td>${entry.texted + entry.called}</td>
                                        <td>${entry.bookedPhone + entry.bookedText}</td>
                                        <td>${entry.enteredBy || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            Generated on ${new Date().toLocaleString()} | Scenthound Bowler Chart Tracker
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            };

            const weeklyData = () => {
                const weeks = {};
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                    
                filteredEntries.forEach(entry => {
                    const parts = entry.date.split('-');
                    const year = parts[0];
                    const week = `${year}-W${getWeekNumber(entry.date)}`;
                    if (!weeks[week]) weeks[week] = [];
                    weeks[week].push(entry);
                });
                return Object.entries(weeks).map(([week, entries]) => ({
                    period: week,
                    ...calculateTotals(entries)
                })).sort((a, b) => b.period.localeCompare(a.period));
            };

            const monthlyData = () => {
                const months = {};
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                    
                filteredEntries.forEach(entry => {
                    const month = getMonthYear(entry.date);
                    if (!months[month]) months[month] = [];
                    months[month].push(entry);
                });
                return Object.entries(months).map(([month, entries]) => {
                    const [year, monthNum] = month.split('-');
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                        'July', 'August', 'September', 'October', 'November', 'December'];
                    return {
                        period: `${monthNames[parseInt(monthNum) - 1]} ${year}`,
                        sortKey: month,
                        ...calculateTotals(entries)
                    };
                }).sort((a, b) => b.sortKey.localeCompare(a.sortKey));
            };

            const yearlyData = () => {
                const years = {};
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                    
                filteredEntries.forEach(entry => {
                    const year = getYearFromDate(entry.date);
                    if (!years[year]) years[year] = [];
                    years[year].push(entry);
                });
                return Object.entries(years).map(([year, entries]) => ({
                    period: year,
                    ...calculateTotals(entries)
                })).sort((a, b) => b.period.localeCompare(a.period));
            };
            
            const getFilteredEntries = () => {
                if (locationFilter === 'All Scenters') return entries;
                return entries.filter(e => e.location === locationFilter);
            };

            const exportToCSV = () => {
                // Individual entries
                const headers = 'Date,Location,New Leads,Active Trial Leads,Texted,Called,Total Contacted,Booked Phone,Booked Text,Total Booked,Entered By,Comments\n';
                const rows = entries.map(e => 
                    `${e.date},${e.location},${e.newLeads},${e.activeTrialLeads},${e.texted},${e.called},${e.texted + e.called},${e.bookedPhone},${e.bookedText},${e.bookedPhone + e.bookedText},"${(e.enteredBy || '').replace(/"/g, '""')}","${(e.comments || '').replace(/"/g, '""')}"`
                ).join('\n');
                
                // Aggregate by date for "All Locations"
                const byDate = {};
                entries.forEach(e => {
                    if (!byDate[e.date]) {
                        byDate[e.date] = {
                            newLeads: 0,
                            activeTrialLeads: 0,
                            texted: 0,
                            called: 0,
                            bookedPhone: 0,
                            bookedText: 0
                        };
                    }
                    byDate[e.date].newLeads += e.newLeads;
                    byDate[e.date].activeTrialLeads += e.activeTrialLeads;
                    byDate[e.date].texted += e.texted;
                    byDate[e.date].called += e.called;
                    byDate[e.date].bookedPhone += e.bookedPhone;
                    byDate[e.date].bookedText += e.bookedText;
                });
                
                const aggregatedRows = Object.entries(byDate)
                    .sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA))
                    .map(([date, data]) => 
                        `${date},All Locations,${data.newLeads},${data.activeTrialLeads},${data.texted},${data.called},${data.texted + data.called},${data.bookedPhone},${data.bookedText},${data.bookedPhone + data.bookedText},"",""`
                    ).join('\n');
                
                // Combine with separator
                const csvContent = headers + rows + '\n\n' + aggregatedRows;
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bowler_chart_data.csv';
                a.click();
            };

            const metricOptions = [
                { value: 'newLeads', label: 'New Leads' },
                { value: 'activeTrialLeads', label: 'Active Trial Leads' },
                { value: 'texted', label: 'Texted' },
                { value: 'called', label: 'Called' },
                { value: 'totalContacted', label: 'Total Contacted' },
                { value: 'bookedPhone', label: 'Booked (Phone)' },
                { value: 'bookedText', label: 'Booked (Text)' },
                { value: 'totalBooked', label: 'Total Booked' }
            ];

            const getChartData = () => {
                let data = [];
                let labels = [];
                
                let filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);

                // Apply date range filter if set
                if (chartDateFrom && chartDateFrom.length > 0) {
                    filteredEntries = filteredEntries.filter(e => e.date >= chartDateFrom);
                }
                if (chartDateTo && chartDateTo.length > 0) {
                    filteredEntries = filteredEntries.filter(e => e.date <= chartDateTo);
                }

                if (chartTimeframe === 'daily') {
                    const grouped = {};
                    filteredEntries.forEach(entry => {
                        const date = entry.date;
                        if (!grouped[date]) {
                            grouped[date] = {
                                newLeads: 0,
                                activeTrialLeads: 0,
                                texted: 0,
                                called: 0,
                                bookedPhone: 0,
                                bookedText: 0,
                                totalContacted: 0,
                                totalBooked: 0
                            };
                        }
                        grouped[date].newLeads += entry.newLeads;
                        grouped[date].activeTrialLeads += entry.activeTrialLeads;
                        grouped[date].texted += entry.texted;
                        grouped[date].called += entry.called;
                        grouped[date].bookedPhone += entry.bookedPhone;
                        grouped[date].bookedText += entry.bookedText;
                        grouped[date].totalContacted += entry.texted + entry.called;
                        grouped[date].totalBooked += entry.bookedPhone + entry.bookedText;
                    });
                    
                    labels = Object.keys(grouped).sort();
                    data = labels.map(date => grouped[date]);
                } else if (chartTimeframe === 'weekly') {
                    const weeks = {};
                    filteredEntries.forEach(entry => {
                        const parts = entry.date.split('-');
                        const year = parts[0];
                        const week = `${year}-W${getWeekNumber(entry.date)}`;
                        if (!weeks[week]) weeks[week] = [];
                        weeks[week].push(entry);
                    });
                    data = Object.entries(weeks).map(([week, entries]) => ({
                        period: week,
                        ...calculateTotals(entries)
                    })).sort((a, b) => a.period.localeCompare(b.period));
                    labels = data.map(d => d.period);
                } else if (chartTimeframe === 'monthly') {
                    const months = {};
                    filteredEntries.forEach(entry => {
                        const month = getMonthYear(entry.date);
                        if (!months[month]) months[month] = [];
                        months[month].push(entry);
                    });
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    data = Object.entries(months).map(([month, entries]) => {
                        const [year, monthNum] = month.split('-');
                        return {
                            period: `${monthNames[parseInt(monthNum) - 1]} ${year}`,
                            sortKey: month,
                            ...calculateTotals(entries)
                        };
                    }).sort((a, b) => a.sortKey.localeCompare(b.sortKey));
                    labels = data.map(d => d.period);
                } else if (chartTimeframe === 'yearly') {
                    const years = {};
                    filteredEntries.forEach(entry => {
                        const year = getYearFromDate(entry.date);
                        if (!years[year]) years[year] = [];
                        years[year].push(entry);
                    });
                    data = Object.entries(years).map(([year, entries]) => ({
                        period: year,
                        ...calculateTotals(entries)
                    })).sort((a, b) => a.period.localeCompare(b.period));
                    labels = data.map(d => d.period);
                }

                return { labels, data };
            };

            const renderChart = () => {
                if (!chartRef.current) return;

                // Destroy existing chart
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const { labels, data } = getChartData();
                const ctx = chartRef.current.getContext('2d');

                const colors = [
                    'rgb(0, 160, 220)',
                    'rgb(255, 107, 53)',
                    'rgb(0, 119, 182)',
                    'rgb(255, 159, 64)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 205, 86)',
                    'rgb(201, 203, 207)'
                ];

                let datasets;

                if (chartType === 'pie' || chartType === 'doughnut') {
                    // For pie/doughnut, sum up each selected metric across all data points
                    const metricTotals = selectedMetrics.map(metric => {
                        const total = data.reduce((sum, d) => sum + (d[metric] || 0), 0);
                        return total;
                    });
                    
                    datasets = [{
                        label: 'Totals',
                        data: metricTotals,
                        backgroundColor: selectedMetrics.map((_, idx) => colors[idx % colors.length].replace('rgb', 'rgba').replace(')', ', 0.7)')),
                        borderColor: selectedMetrics.map((_, idx) => colors[idx % colors.length]),
                        borderWidth: 1
                    }];
                    
                    // Use metric names as labels for pie/doughnut
                    const pieLabels = selectedMetrics.map(metric => 
                        metricOptions.find(m => m.value === metric).label
                    );
                    
                    chartInstance.current = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: pieLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `${locationFilter} - ${chartTimeframe.charAt(0).toUpperCase() + chartTimeframe.slice(1)} Totals`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    datasets = selectedMetrics.map((metric, idx) => {
                        return {
                            label: metricOptions.find(m => m.value === metric).label,
                            data: data.map(d => d[metric] || 0),
                            borderColor: colors[idx % colors.length],
                            backgroundColor: colors[idx % colors.length].replace('rgb', 'rgba').replace(')', ', 0.2)'),
                            tension: 0.1,
                            fill: chartType === 'area'
                        };
                    });
                    
                    chartInstance.current = new Chart(ctx, {
                        type: chartType === 'area' ? 'line' : chartType,
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `${locationFilter} - ${chartTimeframe.charAt(0).toUpperCase() + chartTimeframe.slice(1)} Performance`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            };

            useEffect(() => {
                if (view === 'charts' && entries.length > 0) {
                    renderChart();
                }
            }, [view, chartType, selectedMetrics, chartTimeframe, locationFilter, entries, chartDateFrom, chartDateTo]);

            const toggleMetric = (metric) => {
                setSelectedMetrics(prev => {
                    if (prev.includes(metric)) {
                        return prev.filter(m => m !== metric);
                    } else {
                        return [...prev, metric];
                    }
                });
            };

            if (loading) {
                return <div className="container">Loading...</div>;
            }

            return (
                <div className="container">
                    <div className="header">
                        <h1>üêæ LEASH BOWLER CHART TRACKER üêæ</h1>
                        <div className="subtitle">Daily Performance Tracking by Scenter Location</div>
                    </div>

                    <div className="info-note">
                        <strong>üí° Pro Tip:</strong> Your data is automatically saved to Firebase and synced across all users. Export to CSV regularly for backup and reporting in Google Sheets or Excel.
                    </div>

                    <div className="controls">
                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', alignItems: 'center' }}>
                            <button onClick={() => setShowForm(!showForm)} className="btn">
                                {showForm ? '‚úñ Cancel' : '+ Add Daily Entry'}
                            </button>
                            {entries.length > 0 && (
                                <>
                                    <button onClick={exportToCSV} className="btn btn-secondary">
                                        ‚¨á Export CSV
                                    </button>
                                    <button onClick={() => generatePDFReport('weekly')} className="btn" style={{ background: '#22c55e' }}>
                                        üìÑ Weekly Report
                                    </button>
                                    <button onClick={() => generatePDFReport('monthly')} className="btn" style={{ background: '#8b5cf6' }}>
                                        üìÑ Monthly Report
                                    </button>
                                </>
                            )}
                        </div>
                        <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                            <label style={{ fontSize: '0.9em', color: '#666' }}>Your Name:</label>
                            <input
                                type="text"
                                value={userName}
                                onChange={(e) => {
                                    setUserName(e.target.value);
                                    localStorage.setItem('bowlerUserName', e.target.value);
                                    setCurrentEntry(prev => ({ ...prev, enteredBy: e.target.value }));
                                }}
                                className="form-input"
                                placeholder="Enter your name"
                                style={{ width: '150px' }}
                            />
                        </div>
                    </div>

                    {/* Undo Toast */}
                    {showUndoToast && (
                        <div style={{
                            position: 'fixed',
                            bottom: '20px',
                            right: '20px',
                            background: '#333',
                            color: 'white',
                            padding: '15px 20px',
                            borderRadius: '8px',
                            boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px',
                            zIndex: 1000
                        }}>
                            <span>Entry deleted</span>
                            <button
                                onClick={undoDelete}
                                style={{
                                    background: '#FF6B35',
                                    color: 'white',
                                    border: 'none',
                                    padding: '8px 16px',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontWeight: 600
                                }}
                            >
                                Undo
                            </button>
                            <button
                                onClick={() => setShowUndoToast(false)}
                                style={{
                                    background: 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    cursor: 'pointer',
                                    fontSize: '1.2em'
                                }}
                            >
                                ‚úï
                            </button>
                        </div>
                    )}

                    {/* Trend Indicators Dashboard */}
                    {entries.length > 0 && calculateTrends() && (
                        <div style={{
                            background: 'linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%)',
                            borderRadius: '8px',
                            padding: '20px',
                            marginBottom: '30px',
                            border: '1px solid #00A0DC'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px', flexWrap: 'wrap', gap: '10px' }}>
                                <h3 style={{ margin: 0, color: '#0077B6', fontSize: '1em' }}>
                                    üìà {getTrendPeriodLabel()} ({locationFilter})
                                </h3>
                                <select
                                    value={trendPeriod}
                                    onChange={(e) => setTrendPeriod(e.target.value)}
                                    className="form-input"
                                    style={{ width: 'auto', padding: '8px 12px', fontSize: '0.9em' }}
                                >
                                    <option value="week">This Week vs Last Week</option>
                                    <option value="month">This Month vs Last Month</option>
                                    <option value="last7">Last 7 Days vs Previous 7</option>
                                    <option value="last30">Last 30 Days vs Previous 30</option>
                                </select>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '15px' }}>
                                {(() => {
                                    const trends = calculateTrends();
                                    return (
                                        <>
                                            <div style={{ background: 'white', padding: '15px', borderRadius: '6px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#0077B6' }}>
                                                    {trends.newLeads.current}
                                                    <TrendIndicator trend={trends.newLeads.trend} change={trends.newLeads.change} />
                                                </div>
                                                <div style={{ fontSize: '0.85em', color: '#666' }}>New Leads</div>
                                            </div>
                                            <div style={{ background: 'white', padding: '15px', borderRadius: '6px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#0077B6' }}>
                                                    {trends.activeTrialLeads.current}
                                                    <TrendIndicator trend={trends.activeTrialLeads.trend} change={trends.activeTrialLeads.change} />
                                                </div>
                                                <div style={{ fontSize: '0.85em', color: '#666' }}>Active Trial</div>
                                            </div>
                                            <div style={{ background: 'white', padding: '15px', borderRadius: '6px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#0077B6' }}>
                                                    {trends.totalContacted.current}
                                                    <TrendIndicator trend={trends.totalContacted.trend} change={trends.totalContacted.change} />
                                                </div>
                                                <div style={{ fontSize: '0.85em', color: '#666' }}>Total Contacted</div>
                                            </div>
                                            <div style={{ background: 'white', padding: '15px', borderRadius: '6px', textAlign: 'center' }}>
                                                <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#FF6B35' }}>
                                                    {trends.totalBooked.current}
                                                    <TrendIndicator trend={trends.totalBooked.trend} change={trends.totalBooked.change} />
                                                </div>
                                                <div style={{ fontSize: '0.85em', color: '#666' }}>Total Booked</div>
                                            </div>
                                            <div style={{ background: 'white', padding: '15px', borderRadius: '6px', textAlign: 'center', border: '2px solid #22c55e' }}>
                                                <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#22c55e' }}>
                                                    {trends.conversionRate.current}%
                                                    <TrendIndicator trend={trends.conversionRate.trend} change={trends.conversionRate.change} />
                                                </div>
                                                <div style={{ fontSize: '0.85em', color: '#666' }}>Conversion Rate</div>
                                                <div style={{ fontSize: '0.7em', color: '#999' }}>Booked / New Leads</div>
                                            </div>
                                            <div style={{ background: 'white', padding: '15px', borderRadius: '6px', textAlign: 'center', border: '2px solid #8b5cf6' }}>
                                                <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#8b5cf6' }}>
                                                    {trends.contactRate.current}%
                                                    <TrendIndicator trend={trends.contactRate.trend} change={trends.contactRate.change} />
                                                </div>
                                                <div style={{ fontSize: '0.85em', color: '#666' }}>Contact Rate</div>
                                                <div style={{ fontSize: '0.7em', color: '#999' }}>Contacted / All Leads</div>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    {showForm && (
                        <div className="form-box">
                            <h2 style={{ color: '#0077B6', marginTop: 0, marginBottom: 20 }}>
                                {editingEntry ? '‚úèÔ∏è Edit Entry' : 'üìÖ New Daily Entry'}
                            </h2>
                            <div className="form-grid">
                                <div>
                                    <label className="form-label">Date</label>
                                    <input
                                        type="date"
                                        value={currentEntry.date}
                                        onChange={(e) => setCurrentEntry(prev => ({ ...prev, date: e.target.value }))}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Scenter Location</label>
                                    <select
                                        value={currentEntry.location}
                                        onChange={(e) => setCurrentEntry(prev => ({ ...prev, location: e.target.value }))}
                                        className="form-input"
                                    >
                                        {locations.map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="form-label">New Leads</label>
                                    <input
                                        type="number"
                                        value={currentEntry.newLeads}
                                        onChange={(e) => handleInputChange('newLeads', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Active Trial Leads</label>
                                    <input
                                        type="number"
                                        value={currentEntry.activeTrialLeads}
                                        onChange={(e) => handleInputChange('activeTrialLeads', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Texted</label>
                                    <input
                                        type="number"
                                        value={currentEntry.texted}
                                        onChange={(e) => handleInputChange('texted', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Called</label>
                                    <input
                                        type="number"
                                        value={currentEntry.called}
                                        onChange={(e) => handleInputChange('called', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Booked (Phone)</label>
                                    <input
                                        type="number"
                                        value={currentEntry.bookedPhone}
                                        onChange={(e) => handleInputChange('bookedPhone', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Booked (Text)</label>
                                    <input
                                        type="number"
                                        value={currentEntry.bookedText}
                                        onChange={(e) => handleInputChange('bookedText', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                            </div>
                            <div style={{ marginTop: '20px', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px' }}>
                                <div>
                                    <label className="form-label">Your Name</label>
                                    <input
                                        type="text"
                                        value={currentEntry.enteredBy}
                                        onChange={(e) => handleInputChange('enteredBy', e.target.value)}
                                        className="form-input"
                                        placeholder="Enter your name"
                                    />
                                </div>
                                <div style={{ flex: 2 }}>
                                    <label className="form-label">Comments / Notes</label>
                                    <textarea
                                        value={currentEntry.comments}
                                        onChange={(e) => handleInputChange('comments', e.target.value)}
                                        className="form-input"
                                        rows="2"
                                        placeholder="e.g., John Doe - requested callback tomorrow"
                                        style={{ resize: 'vertical' }}
                                    />
                                </div>
                            </div>
                            <p style={{ fontSize: '0.85em', color: '#666', marginTop: '5px' }}>
                                Note any leads/active trials not contacted and why (requested callback, bad number, etc.)
                            </p>
                            <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                                <button onClick={addEntry} className="btn">
                                    {editingEntry ? '‚úì Update Entry' : '‚úì Save Entry'}
                                </button>
                                <button onClick={cancelEdit} className="btn btn-cancel">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="view-tabs">
                        <button
                            onClick={() => setView('daily')}
                            className={`tab ${view === 'daily' ? 'active' : ''}`}
                        >
                            Daily View
                        </button>
                        <button
                            onClick={() => setView('weekly')}
                            className={`tab ${view === 'weekly' ? 'active' : ''}`}
                        >
                            Weekly View
                        </button>
                        <button
                            onClick={() => setView('monthly')}
                            className={`tab ${view === 'monthly' ? 'active' : ''}`}
                        >
                            Monthly View
                        </button>
                        <button
                            onClick={() => setView('yearly')}
                            className={`tab ${view === 'yearly' ? 'active' : ''}`}
                        >
                            Yearly View
                        </button>
                        <button
                            onClick={() => setView('charts')}
                            className={`tab ${view === 'charts' ? 'active' : ''}`}
                        >
                            üìä Charts
                        </button>
                    </div>

                    <div style={{ marginBottom: '20px' }}>
                        <label className="form-label">Filter by Location:</label>
                        <select
                            value={locationFilter}
                            onChange={(e) => setLocationFilter(e.target.value)}
                            className="form-input"
                            style={{ maxWidth: '300px' }}
                        >
                            <option value="All Scenters">All Scenters (Combined)</option>
                            {locations.map(loc => (
                                <option key={loc} value={loc}>{loc}</option>
                            ))}
                        </select>
                    </div>

                    {entries.length === 0 ? (
                        <div className="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <h2 style={{ color: '#00A0DC' }}>No Entries Yet</h2>
                            <p style={{ fontSize: '1.1em' }}>Click "Add Daily Entry" to start tracking your performance!</p>
                        </div>
                    ) : view === 'charts' ? (
                        <div>
                            <div className="form-box">
                                <h3 style={{ color: '#0077B6', marginTop: 0 }}>Chart Configuration</h3>
                                
                                <div style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Chart Type</label>
                                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                        <button
                                            onClick={() => setChartType('line')}
                                            className={chartType === 'line' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Line Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('bar')}
                                            className={chartType === 'bar' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Bar Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('area')}
                                            className={chartType === 'area' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Area Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('pie')}
                                            className={chartType === 'pie' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Pie Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('doughnut')}
                                            className={chartType === 'doughnut' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Doughnut Chart
                                        </button>
                                    </div>
                                </div>

                                <div style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Timeframe</label>
                                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                        <button
                                            onClick={() => setChartTimeframe('daily')}
                                            className={chartTimeframe === 'daily' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Daily
                                        </button>
                                        <button
                                            onClick={() => setChartTimeframe('weekly')}
                                            className={chartTimeframe === 'weekly' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Weekly
                                        </button>
                                        <button
                                            onClick={() => setChartTimeframe('monthly')}
                                            className={chartTimeframe === 'monthly' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Monthly
                                        </button>
                                        <button
                                            onClick={() => setChartTimeframe('yearly')}
                                            className={chartTimeframe === 'yearly' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Yearly
                                        </button>
                                    </div>
                                </div>

                                <div style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Date Range Filter (Optional)</label>
                                    <p style={{ fontSize: '0.85em', color: '#666', marginBottom: '10px' }}>
                                        Filter data to a specific date range for focused analysis
                                    </p>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', alignItems: 'flex-end' }}>
                                        <div style={{ marginRight: '20px', marginBottom: '10px' }}>
                                            <label style={{ fontSize: '0.9em', color: '#666', display: 'block', marginBottom: '5px' }}>From Date</label>
                                            <input
                                                type="date"
                                                value={chartDateFrom}
                                                onChange={(e) => setChartDateFrom(e.target.value)}
                                                className="form-input"
                                                style={{ width: '180px', boxSizing: 'border-box' }}
                                            />
                                        </div>
                                        <div style={{ marginRight: '20px', marginBottom: '10px' }}>
                                            <label style={{ fontSize: '0.9em', color: '#666', display: 'block', marginBottom: '5px' }}>To Date</label>
                                            <input
                                                type="date"
                                                value={chartDateTo}
                                                onChange={(e) => setChartDateTo(e.target.value)}
                                                className="form-input"
                                                style={{ width: '180px', boxSizing: 'border-box' }}
                                            />
                                        </div>
                                        <div style={{ marginBottom: '10px' }}>
                                            <button
                                                onClick={() => {
                                                    setChartDateFrom('');
                                                    setChartDateTo('');
                                                }}
                                                className="btn btn-cancel"
                                                style={{ padding: '10px 20px', whiteSpace: 'nowrap' }}
                                            >
                                                Clear Dates
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="form-label">Metrics to Display (select multiple)</label>
                                    {(chartType === 'pie' || chartType === 'doughnut') && (
                                        <p style={{ fontSize: '0.85em', color: '#666', marginBottom: '10px' }}>
                                            Pie/Doughnut charts show total values for each selected metric
                                        </p>
                                    )}
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
                                        {metricOptions.map(metric => (
                                            <label key={metric.value} style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedMetrics.includes(metric.value)}
                                                    onChange={() => toggleMetric(metric.value)}
                                                    style={{ marginRight: '8px', cursor: 'pointer' }}
                                                />
                                                <span>{metric.label}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div style={{ background: 'white', padding: '20px', borderRadius: '8px', marginTop: '20px' }}>
                                <canvas ref={chartRef} style={{ maxHeight: '500px' }}></canvas>
                            </div>
                        </div>
                    ) : (
                        <div style={{ overflowX: 'auto' }}>
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>{view === 'daily' ? 'Date' : 'Period'}</th>
                                        <th>Location</th>
                                        <th className="text-right">New Leads</th>
                                        <th className="text-right">Active Trial</th>
                                        <th className="text-right">Texted</th>
                                        <th className="text-right">Called</th>
                                        <th className="text-right highlight">Total Contacted</th>
                                        <th className="text-right">Phone</th>
                                        <th className="text-right">Text</th>
                                        <th className="text-right highlight">Total Booked</th>
                                        {view === 'daily' && <th>Entered By</th>}
                                        {view === 'daily' && <th>Comments</th>}
                                        {view === 'daily' && <th>Actions</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {view === 'daily' && getFilteredEntries().map((entry, idx) => (
                                        <tr key={idx}>
                                            <td>{entry.date}</td>
                                            <td><strong>{entry.location}</strong></td>
                                            <td className="text-right">{entry.newLeads}</td>
                                            <td className="text-right">{entry.activeTrialLeads}</td>
                                            <td className="text-right">{entry.texted}</td>
                                            <td className="text-right">{entry.called}</td>
                                            <td className="text-right highlight">
                                                {entry.texted + entry.called}
                                            </td>
                                            <td className="text-right">{entry.bookedPhone}</td>
                                            <td className="text-right">{entry.bookedText}</td>
                                            <td className="text-right highlight">
                                                {entry.bookedPhone + entry.bookedText}
                                            </td>
                                            <td style={{ fontSize: '0.85em' }}>{entry.enteredBy || '-'}</td>
                                            <td style={{ fontSize: '0.85em', maxWidth: '200px' }}>{entry.comments || '-'}</td>
                                            <td>
                                                <button onClick={() => editEntry(idx)} className="edit-btn">
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button onClick={() => deleteEntry(idx)} className="delete-btn">
                                                    üóë Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {view === 'weekly' && weeklyData().map((week, idx) => (
                                        <tr key={idx}>
                                            <td style={{ fontWeight: 600 }}>{week.period}</td>
                                            <td><em>{locationFilter}</em></td>
                                            <td className="text-right">{week.newLeads}</td>
                                            <td className="text-right">{week.activeTrialLeads}</td>
                                            <td className="text-right">{week.texted}</td>
                                            <td className="text-right">{week.called}</td>
                                            <td className="text-right highlight">{week.totalContacted}</td>
                                            <td className="text-right">{week.bookedPhone}</td>
                                            <td className="text-right">{week.bookedText}</td>
                                            <td className="text-right highlight">{week.totalBooked}</td>
                                        </tr>
                                    ))}
                                    {view === 'monthly' && monthlyData().map((month, idx) => (
                                        <tr key={idx}>
                                            <td style={{ fontWeight: 600 }}>{month.period}</td>
                                            <td><em>{locationFilter}</em></td>
                                            <td className="text-right">{month.newLeads}</td>
                                            <td className="text-right">{month.activeTrialLeads}</td>
                                            <td className="text-right">{month.texted}</td>
                                            <td className="text-right">{month.called}</td>
                                            <td className="text-right highlight">{month.totalContacted}</td>
                                            <td className="text-right">{month.bookedPhone}</td>
                                            <td className="text-right">{month.bookedText}</td>
                                            <td className="text-right highlight">{month.totalBooked}</td>
                                        </tr>
                                    ))}
                                    {view === 'yearly' && yearlyData().map((year, idx) => (
                                        <tr key={idx}>
                                            <td style={{ fontWeight: 600 }}>{year.period}</td>
                                            <td><em>{locationFilter}</em></td>
                                            <td className="text-right">{year.newLeads}</td>
                                            <td className="text-right">{year.activeTrialLeads}</td>
                                            <td className="text-right">{year.texted}</td>
                                            <td className="text-right">{year.called}</td>
                                            <td className="text-right highlight">{year.totalContacted}</td>
                                            <td className="text-right">{year.bookedPhone}</td>
                                            <td className="text-right">{year.bookedText}</td>
                                            <td className="text-right highlight">{year.totalBooked}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    <div style={{ textAlign: 'center', padding: '40px 20px', color: '#0077B6', marginTop: '40px' }}>
                        <span style={{ color: '#FF6B35', fontSize: '1.5em' }}>üêæ</span>
                        <strong> SCENTHOUND</strong> - Making dog care routine, affordable, and accessible
                        <span style={{ color: '#FF6B35', fontSize: '1.5em' }}> üêæ</span>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<BowlerTracker />, document.getElementById('root'));
    </script>
</body>
</html>
