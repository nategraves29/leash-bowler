<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bowler Chart Tracker - Scenthound</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: #f8f8f8;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 0;
            box-shadow: none;
            max-width: 100%;
            margin: 0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 40px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 400;
            margin-top: 5px;
        }

        .btn {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: 'Poppins', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 160, 220, 0.3);
        }

        .btn-secondary {
            background: #FF6B35;
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .btn-cancel {
            background: #999;
        }

        .btn-cancel:hover {
            background: #777;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .form-box {
            background: #f0f9ff;
            border-left: 5px solid #00A0DC;
            padding: 30px;
            margin: 30px 0;
            border-radius: 8px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #0077B6;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #00A0DC;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            border: 2px solid #00A0DC;
            background: white;
            color: #00A0DC;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
        }

        .tab:hover {
            background: #e6f7ff;
        }

        .tab.active {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
            border-color: #0077B6;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table thead {
            background: linear-gradient(135deg, #00A0DC 0%, #0077B6 100%);
            color: white;
        }

        .data-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table th.text-right {
            text-align: right;
        }

        .data-table th.highlight {
            background: #0077B6;
        }

        .data-table th.conversion {
            background: #FF6B35;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table td.text-right {
            text-align: right;
        }

        .data-table tbody tr:hover {
            background: #f0f9ff;
        }

        .data-table td.highlight {
            background: #f0f9ff;
            font-weight: 600;
        }

        .data-table td.conversion {
            background: #fff8f0;
            font-weight: 600;
            color: #FF6B35;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .edit-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background: #e0a800;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .info-note {
            background: #fff8f0;
            border-left: 4px solid #FF6B35;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 0.95em;
        }

        .info-note strong {
            color: #FF6B35;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 0.85em;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase - Load before using Firebase services -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyCgQV7FiS6V28Yy-bdCNik2tHdmrcz0L6E",
        authDomain: "leash-bowler.firebaseapp.com",
        projectId: "leash-bowler",
        storageBucket: "leash-bowler.firebasestorage.app",
        messagingSenderId: "363242291452",
        appId: "1:363242291452:web:2b5f6c007e129fd1e45779"
      };
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      
      // Make Firebase available globally
      window.firebaseDB = db;
      window.firestoreCollection = collection;
      window.firestoreGetDocs = getDocs;
      window.firestoreAddDoc = addDoc;
      window.firestoreDeleteDoc = deleteDoc;
      window.firestoreDoc = doc;
      window.firestoreOnSnapshot = onSnapshot;
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const BowlerTracker = () => {
            const [entries, setEntries] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('daily');
            const [locationFilter, setLocationFilter] = useState('All Scenters');
            const [chartType, setChartType] = useState('line');
            const [selectedMetrics, setSelectedMetrics] = useState(['newLeads', 'activeTrialLeads']);
            const [chartTimeframe, setChartTimeframe] = useState('daily');
            const [editingEntry, setEditingEntry] = useState(null);
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);
            const [currentEntry, setCurrentEntry] = useState({
                date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
                location: 'Cedar Mill',
                newLeads: 0,
                activeTrialLeads: 0,
                texted: 0,
                called: 0,
                bookedPhone: 0,
                bookedText: 0,
                comments: ''
            });
            
            const locations = ['Cedar Mill', 'Tigard', 'Hillsboro', 'Sherwood'];

            useEffect(() => {
                // Wait for Firebase to be ready
                const checkFirebase = setInterval(() => {
                    if (window.firebaseDB) {
                        clearInterval(checkFirebase);
                        loadEntriesFromFirebase();
                    }
                }, 100);
                
                return () => clearInterval(checkFirebase);
            }, []);

            const loadEntriesFromFirebase = async () => {
                try {
                    const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                    const snapshot = await window.firestoreGetDocs(entriesCol);
                    const entriesData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setEntries(entriesData.sort((a, b) => new Date(b.date) - new Date(a.date)));
                } catch (error) {
                    console.error('Error loading entries:', error);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (!loading) {
                    // No longer need to save to localStorage
                    // Data is automatically saved to Firebase when added
                }
            }, [entries, loading]);

            const handleInputChange = (field, value) => {
                setCurrentEntry(prev => ({
                    ...prev,
                    [field]: field === 'comments' ? value : (parseInt(value) || 0)
                }));
            };

            const addEntry = async () => {
                try {
                    if (editingEntry) {
                        // Update existing entry
                        const docRef = window.firestoreDoc(window.firebaseDB, 'entries', editingEntry.id);
                        await window.firestoreDeleteDoc(docRef);
                        const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                        await window.firestoreAddDoc(entriesCol, currentEntry);
                        setEditingEntry(null);
                    } else {
                        // Add new entry
                        const entriesCol = window.firestoreCollection(window.firebaseDB, 'entries');
                        await window.firestoreAddDoc(entriesCol, currentEntry);
                    }
                    await loadEntriesFromFirebase();
                    setCurrentEntry({
                        date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
                        location: 'Cedar Mill',
                        newLeads: 0,
                        activeTrialLeads: 0,
                        texted: 0,
                        called: 0,
                        bookedPhone: 0,
                        bookedText: 0,
                        comments: ''
                    });
                    setShowForm(false);
                } catch (error) {
                    console.error('Error saving entry:', error);
                    alert('Error saving entry. Please try again.');
                }
            };

            const deleteEntry = async (index) => {
                if (confirm('Are you sure you want to delete this entry?')) {
                    try {
                        const entry = getFilteredEntries()[index];
                        const docRef = window.firestoreDoc(window.firebaseDB, 'entries', entry.id);
                        await window.firestoreDeleteDoc(docRef);
                        await loadEntriesFromFirebase();
                    } catch (error) {
                        console.error('Error deleting entry:', error);
                        alert('Error deleting entry. Please try again.');
                    }
                }
            };

            const editEntry = (index) => {
                const entry = getFilteredEntries()[index];
                setCurrentEntry({
                    date: entry.date,
                    location: entry.location,
                    newLeads: entry.newLeads,
                    activeTrialLeads: entry.activeTrialLeads,
                    texted: entry.texted,
                    called: entry.called,
                    bookedPhone: entry.bookedPhone,
                    bookedText: entry.bookedText,
                    comments: entry.comments || ''
                });
                setEditingEntry(entry);
                setShowForm(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setEditingEntry(null);
                setCurrentEntry({
                    date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0],
                    location: 'Cedar Mill',
                    newLeads: 0,
                    activeTrialLeads: 0,
                    texted: 0,
                    called: 0,
                    bookedPhone: 0,
                    bookedText: 0,
                    comments: ''
                });
                setShowForm(false);
            };

            const getWeekNumber = (date) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            const getMonthYear = (date) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            };

            const calculateTotals = (entriesSubset) => {
                return entriesSubset.reduce((acc, entry) => ({
                    newLeads: acc.newLeads + entry.newLeads,
                    activeTrialLeads: acc.activeTrialLeads + entry.activeTrialLeads,
                    texted: acc.texted + entry.texted,
                    called: acc.called + entry.called,
                    bookedPhone: acc.bookedPhone + entry.bookedPhone,
                    bookedText: acc.bookedText + entry.bookedText,
                    totalContacted: acc.totalContacted + entry.texted + entry.called,
                    totalBooked: acc.totalBooked + entry.bookedPhone + entry.bookedText
                }), {
                    newLeads: 0,
                    activeTrialLeads: 0,
                    texted: 0,
                    called: 0,
                    bookedPhone: 0,
                    bookedText: 0,
                    totalContacted: 0,
                    totalBooked: 0
                });
            };

            const weeklyData = () => {
                const weeks = {};
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                    
                filteredEntries.forEach(entry => {
                    const week = `${new Date(entry.date).getFullYear()}-W${getWeekNumber(entry.date)}`;
                    if (!weeks[week]) weeks[week] = [];
                    weeks[week].push(entry);
                });
                return Object.entries(weeks).map(([week, entries]) => ({
                    period: week,
                    ...calculateTotals(entries)
                })).sort((a, b) => b.period.localeCompare(a.period));
            };

            const monthlyData = () => {
                const months = {};
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                    
                filteredEntries.forEach(entry => {
                    const month = getMonthYear(entry.date);
                    if (!months[month]) months[month] = [];
                    months[month].push(entry);
                });
                return Object.entries(months).map(([month, entries]) => ({
                    period: new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' }),
                    ...calculateTotals(entries)
                })).sort((a, b) => b.period.localeCompare(a.period));
            };

            const yearlyData = () => {
                const years = {};
                const filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);
                    
                filteredEntries.forEach(entry => {
                    const year = new Date(entry.date).getFullYear().toString();
                    if (!years[year]) years[year] = [];
                    years[year].push(entry);
                });
                return Object.entries(years).map(([year, entries]) => ({
                    period: year,
                    ...calculateTotals(entries)
                })).sort((a, b) => b.period.localeCompare(a.period));
            };
            
            const getFilteredEntries = () => {
                if (locationFilter === 'All Scenters') return entries;
                return entries.filter(e => e.location === locationFilter);
            };

            const exportToCSV = () => {
                // Individual entries
                const headers = 'Date,Location,New Leads,Active Trial Leads,Texted,Called,Total Contacted,Booked Phone,Booked Text,Total Booked,Comments\n';
                const rows = entries.map(e => 
                    `${e.date},${e.location},${e.newLeads},${e.activeTrialLeads},${e.texted},${e.called},${e.texted + e.called},${e.bookedPhone},${e.bookedText},${e.bookedPhone + e.bookedText},"${(e.comments || '').replace(/"/g, '""')}"`
                ).join('\n');
                
                // Aggregate by date for "All Locations"
                const byDate = {};
                entries.forEach(e => {
                    if (!byDate[e.date]) {
                        byDate[e.date] = {
                            newLeads: 0,
                            activeTrialLeads: 0,
                            texted: 0,
                            called: 0,
                            bookedPhone: 0,
                            bookedText: 0
                        };
                    }
                    byDate[e.date].newLeads += e.newLeads;
                    byDate[e.date].activeTrialLeads += e.activeTrialLeads;
                    byDate[e.date].texted += e.texted;
                    byDate[e.date].called += e.called;
                    byDate[e.date].bookedPhone += e.bookedPhone;
                    byDate[e.date].bookedText += e.bookedText;
                });
                
                const aggregatedRows = Object.entries(byDate)
                    .sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA))
                    .map(([date, data]) => 
                        `${date},All Locations,${data.newLeads},${data.activeTrialLeads},${data.texted},${data.called},${data.texted + data.called},${data.bookedPhone},${data.bookedText},${data.bookedPhone + data.bookedText},""`
                    ).join('\n');
                
                // Combine with separator
                const csvContent = headers + rows + '\n\n' + aggregatedRows;
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bowler_chart_data.csv';
                a.click();
            };

            const metricOptions = [
                { value: 'newLeads', label: 'New Leads' },
                { value: 'activeTrialLeads', label: 'Active Trial Leads' },
                { value: 'texted', label: 'Texted' },
                { value: 'called', label: 'Called' },
                { value: 'totalContacted', label: 'Total Contacted' },
                { value: 'bookedPhone', label: 'Booked (Phone)' },
                { value: 'bookedText', label: 'Booked (Text)' },
                { value: 'totalBooked', label: 'Total Booked' }
            ];

            const getChartData = () => {
                let data = [];
                let labels = [];
                
                let filteredEntries = locationFilter === 'All Scenters' 
                    ? entries 
                    : entries.filter(e => e.location === locationFilter);

                if (chartTimeframe === 'daily') {
                    const grouped = {};
                    filteredEntries.forEach(entry => {
                        const date = entry.date;
                        if (!grouped[date]) {
                            grouped[date] = {
                                newLeads: 0,
                                activeTrialLeads: 0,
                                texted: 0,
                                called: 0,
                                bookedPhone: 0,
                                bookedText: 0,
                                totalContacted: 0,
                                totalBooked: 0
                            };
                        }
                        grouped[date].newLeads += entry.newLeads;
                        grouped[date].activeTrialLeads += entry.activeTrialLeads;
                        grouped[date].texted += entry.texted;
                        grouped[date].called += entry.called;
                        grouped[date].bookedPhone += entry.bookedPhone;
                        grouped[date].bookedText += entry.bookedText;
                        grouped[date].totalContacted += entry.texted + entry.called;
                        grouped[date].totalBooked += entry.bookedPhone + entry.bookedText;
                    });
                    
                    labels = Object.keys(grouped).sort();
                    data = labels.map(date => grouped[date]);
                } else if (chartTimeframe === 'weekly') {
                    const weeks = {};
                    filteredEntries.forEach(entry => {
                        const week = `${new Date(entry.date).getFullYear()}-W${getWeekNumber(entry.date)}`;
                        if (!weeks[week]) weeks[week] = [];
                        weeks[week].push(entry);
                    });
                    data = Object.entries(weeks).map(([week, entries]) => ({
                        period: week,
                        ...calculateTotals(entries)
                    })).sort((a, b) => a.period.localeCompare(b.period));
                    labels = data.map(d => d.period);
                } else if (chartTimeframe === 'monthly') {
                    const months = {};
                    filteredEntries.forEach(entry => {
                        const month = getMonthYear(entry.date);
                        if (!months[month]) months[month] = [];
                        months[month].push(entry);
                    });
                    data = Object.entries(months).map(([month, entries]) => ({
                        period: new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' }),
                        ...calculateTotals(entries)
                    })).sort((a, b) => a.period.localeCompare(b.period));
                    labels = data.map(d => d.period);
                } else if (chartTimeframe === 'yearly') {
                    const years = {};
                    filteredEntries.forEach(entry => {
                        const year = new Date(entry.date).getFullYear().toString();
                        if (!years[year]) years[year] = [];
                        years[year].push(entry);
                    });
                    data = Object.entries(years).map(([year, entries]) => ({
                        period: year,
                        ...calculateTotals(entries)
                    })).sort((a, b) => a.period.localeCompare(b.period));
                    labels = data.map(d => d.period);
                }

                return { labels, data };
            };

            const renderChart = () => {
                if (!chartRef.current) return;

                // Destroy existing chart
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const { labels, data } = getChartData();
                const ctx = chartRef.current.getContext('2d');

                const colors = [
                    'rgb(0, 160, 220)',
                    'rgb(255, 107, 53)',
                    'rgb(0, 119, 182)',
                    'rgb(255, 159, 64)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 205, 86)',
                    'rgb(201, 203, 207)'
                ];

                let datasets;

                if (chartType === 'pie' || chartType === 'doughnut') {
                    // For pie/doughnut, sum up each selected metric across all data points
                    const metricTotals = selectedMetrics.map(metric => {
                        const total = data.reduce((sum, d) => sum + (d[metric] || 0), 0);
                        return total;
                    });
                    
                    datasets = [{
                        label: 'Totals',
                        data: metricTotals,
                        backgroundColor: selectedMetrics.map((_, idx) => colors[idx % colors.length].replace('rgb', 'rgba').replace(')', ', 0.7)')),
                        borderColor: selectedMetrics.map((_, idx) => colors[idx % colors.length]),
                        borderWidth: 1
                    }];
                    
                    // Use metric names as labels for pie/doughnut
                    const pieLabels = selectedMetrics.map(metric => 
                        metricOptions.find(m => m.value === metric).label
                    );
                    
                    chartInstance.current = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: pieLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `${locationFilter} - ${chartTimeframe.charAt(0).toUpperCase() + chartTimeframe.slice(1)} Totals`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    datasets = selectedMetrics.map((metric, idx) => {
                        return {
                            label: metricOptions.find(m => m.value === metric).label,
                            data: data.map(d => d[metric] || 0),
                            borderColor: colors[idx % colors.length],
                            backgroundColor: colors[idx % colors.length].replace('rgb', 'rgba').replace(')', ', 0.2)'),
                            tension: 0.1,
                            fill: chartType === 'area'
                        };
                    });
                    
                    chartInstance.current = new Chart(ctx, {
                        type: chartType === 'area' ? 'line' : chartType,
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `${locationFilter} - ${chartTimeframe.charAt(0).toUpperCase() + chartTimeframe.slice(1)} Performance`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            };

            useEffect(() => {
                if (view === 'charts' && entries.length > 0) {
                    renderChart();
                }
            }, [view, chartType, selectedMetrics, chartTimeframe, locationFilter, entries]);

            const toggleMetric = (metric) => {
                setSelectedMetrics(prev => {
                    if (prev.includes(metric)) {
                        return prev.filter(m => m !== metric);
                    } else {
                        return [...prev, metric];
                    }
                });
            };

            if (loading) {
                return <div className="container">Loading...</div>;
            }

            return (
                <div className="container">
                    <div className="header">
                        <h1>üêæ LEASH BOWLER CHART TRACKER üêæ</h1>
                        <div className="subtitle">Daily Performance Tracking by Scenter Location</div>
                    </div>

                    <div className="info-note">
                        <strong>üí° Pro Tip:</strong> Your data is automatically saved to Firebase and synced across all users. Export to CSV regularly for backup and reporting in Google Sheets or Excel.
                    </div>

                    <div className="controls">
                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                            <button onClick={() => setShowForm(!showForm)} className="btn">
                                {showForm ? '‚úñ Cancel' : '+ Add Daily Entry'}
                            </button>
                            {entries.length > 0 && (
                                <button onClick={exportToCSV} className="btn btn-secondary">
                                    ‚¨á Export to CSV
                                </button>
                            )}
                        </div>
                    </div>

                    {showForm && (
                        <div className="form-box">
                            <h2 style={{ color: '#0077B6', marginTop: 0, marginBottom: 20 }}>
                                {editingEntry ? '‚úèÔ∏è Edit Entry' : 'üìÖ New Daily Entry'}
                            </h2>
                            <div className="form-grid">
                                <div>
                                    <label className="form-label">Date</label>
                                    <input
                                        type="date"
                                        value={currentEntry.date}
                                        onChange={(e) => setCurrentEntry(prev => ({ ...prev, date: e.target.value }))}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Scenter Location</label>
                                    <select
                                        value={currentEntry.location}
                                        onChange={(e) => setCurrentEntry(prev => ({ ...prev, location: e.target.value }))}
                                        className="form-input"
                                    >
                                        {locations.map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="form-label">New Leads</label>
                                    <input
                                        type="number"
                                        value={currentEntry.newLeads}
                                        onChange={(e) => handleInputChange('newLeads', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Active Trial Leads</label>
                                    <input
                                        type="number"
                                        value={currentEntry.activeTrialLeads}
                                        onChange={(e) => handleInputChange('activeTrialLeads', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Texted</label>
                                    <input
                                        type="number"
                                        value={currentEntry.texted}
                                        onChange={(e) => handleInputChange('texted', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Called</label>
                                    <input
                                        type="number"
                                        value={currentEntry.called}
                                        onChange={(e) => handleInputChange('called', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Booked (Phone)</label>
                                    <input
                                        type="number"
                                        value={currentEntry.bookedPhone}
                                        onChange={(e) => handleInputChange('bookedPhone', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                                <div>
                                    <label className="form-label">Booked (Text)</label>
                                    <input
                                        type="number"
                                        value={currentEntry.bookedText}
                                        onChange={(e) => handleInputChange('bookedText', e.target.value)}
                                        className="form-input"
                                    />
                                </div>
                            </div>
                            <div style={{ marginTop: '20px' }}>
                                <label className="form-label">Comments / Notes</label>
                                <textarea
                                    value={currentEntry.comments}
                                    onChange={(e) => handleInputChange('comments', e.target.value)}
                                    className="form-input"
                                    rows="3"
                                    placeholder="e.g., John Doe - requested callback tomorrow; Jane Smith - unreachable phone number"
                                    style={{ resize: 'vertical' }}
                                />
                                <p style={{ fontSize: '0.85em', color: '#666', marginTop: '5px' }}>
                                    Note any leads/active trials not contacted and why (requested callback, bad number, etc.)
                                </p>
                            </div>
                            <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                                <button onClick={addEntry} className="btn">
                                    {editingEntry ? '‚úì Update Entry' : '‚úì Save Entry'}
                                </button>
                                <button onClick={cancelEdit} className="btn btn-cancel">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="view-tabs">
                        <button
                            onClick={() => setView('daily')}
                            className={`tab ${view === 'daily' ? 'active' : ''}`}
                        >
                            Daily View
                        </button>
                        <button
                            onClick={() => setView('weekly')}
                            className={`tab ${view === 'weekly' ? 'active' : ''}`}
                        >
                            Weekly View
                        </button>
                        <button
                            onClick={() => setView('monthly')}
                            className={`tab ${view === 'monthly' ? 'active' : ''}`}
                        >
                            Monthly View
                        </button>
                        <button
                            onClick={() => setView('yearly')}
                            className={`tab ${view === 'yearly' ? 'active' : ''}`}
                        >
                            Yearly View
                        </button>
                        <button
                            onClick={() => setView('charts')}
                            className={`tab ${view === 'charts' ? 'active' : ''}`}
                        >
                            üìä Charts
                        </button>
                    </div>

                    <div style={{ marginBottom: '20px' }}>
                        <label className="form-label">Filter by Location:</label>
                        <select
                            value={locationFilter}
                            onChange={(e) => setLocationFilter(e.target.value)}
                            className="form-input"
                            style={{ maxWidth: '300px' }}
                        >
                            <option value="All Scenters">All Scenters (Combined)</option>
                            {locations.map(loc => (
                                <option key={loc} value={loc}>{loc}</option>
                            ))}
                        </select>
                    </div>

                    {entries.length === 0 ? (
                        <div className="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <h2 style={{ color: '#00A0DC' }}>No Entries Yet</h2>
                            <p style={{ fontSize: '1.1em' }}>Click "Add Daily Entry" to start tracking your performance!</p>
                        </div>
                    ) : view === 'charts' ? (
                        <div>
                            <div className="form-box">
                                <h3 style={{ color: '#0077B6', marginTop: 0 }}>Chart Configuration</h3>
                                
                                <div style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Chart Type</label>
                                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                        <button
                                            onClick={() => setChartType('line')}
                                            className={chartType === 'line' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Line Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('bar')}
                                            className={chartType === 'bar' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Bar Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('area')}
                                            className={chartType === 'area' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Area Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('pie')}
                                            className={chartType === 'pie' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Pie Chart
                                        </button>
                                        <button
                                            onClick={() => setChartType('doughnut')}
                                            className={chartType === 'doughnut' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Doughnut Chart
                                        </button>
                                    </div>
                                </div>

                                <div style={{ marginBottom: '20px' }}>
                                    <label className="form-label">Timeframe</label>
                                    <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                        <button
                                            onClick={() => setChartTimeframe('daily')}
                                            className={chartTimeframe === 'daily' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Daily
                                        </button>
                                        <button
                                            onClick={() => setChartTimeframe('weekly')}
                                            className={chartTimeframe === 'weekly' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Weekly
                                        </button>
                                        <button
                                            onClick={() => setChartTimeframe('monthly')}
                                            className={chartTimeframe === 'monthly' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Monthly
                                        </button>
                                        <button
                                            onClick={() => setChartTimeframe('yearly')}
                                            className={chartTimeframe === 'yearly' ? 'btn' : 'btn btn-cancel'}
                                            style={{ padding: '8px 16px' }}
                                        >
                                            Yearly
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label className="form-label">Metrics to Display (select multiple)</label>
                                    {(chartType === 'pie' || chartType === 'doughnut') && (
                                        <p style={{ fontSize: '0.85em', color: '#666', marginBottom: '10px' }}>
                                            Pie/Doughnut charts show total values for each selected metric
                                        </p>
                                    )}
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
                                        {metricOptions.map(metric => (
                                            <label key={metric.value} style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedMetrics.includes(metric.value)}
                                                    onChange={() => toggleMetric(metric.value)}
                                                    style={{ marginRight: '8px', cursor: 'pointer' }}
                                                />
                                                <span>{metric.label}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div style={{ background: 'white', padding: '20px', borderRadius: '8px', marginTop: '20px' }}>
                                <canvas ref={chartRef} style={{ maxHeight: '500px' }}></canvas>
                            </div>
                        </div>
                    ) : (
                        <div style={{ overflowX: 'auto' }}>
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>{view === 'daily' ? 'Date' : 'Period'}</th>
                                        <th>Location</th>
                                        <th className="text-right">New Leads</th>
                                        <th className="text-right">Active Trial</th>
                                        <th className="text-right">Texted</th>
                                        <th className="text-right">Called</th>
                                        <th className="text-right highlight">Total Contacted</th>
                                        <th className="text-right">Phone</th>
                                        <th className="text-right">Text</th>
                                        <th className="text-right highlight">Total Booked</th>
                                        {view === 'daily' && <th>Comments</th>}
                                        {view === 'daily' && <th>Actions</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {view === 'daily' && getFilteredEntries().map((entry, idx) => (
                                        <tr key={idx}>
                                            <td>{entry.date}</td>
                                            <td><strong>{entry.location}</strong></td>
                                            <td className="text-right">{entry.newLeads}</td>
                                            <td className="text-right">{entry.activeTrialLeads}</td>
                                            <td className="text-right">{entry.texted}</td>
                                            <td className="text-right">{entry.called}</td>
                                            <td className="text-right highlight">
                                                {entry.texted + entry.called}
                                            </td>
                                            <td className="text-right">{entry.bookedPhone}</td>
                                            <td className="text-right">{entry.bookedText}</td>
                                            <td className="text-right highlight">
                                                {entry.bookedPhone + entry.bookedText}
                                            </td>
                                            <td style={{ fontSize: '0.85em', maxWidth: '200px' }}>{entry.comments || '-'}</td>
                                            <td>
                                                <button onClick={() => editEntry(idx)} className="edit-btn">
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button onClick={() => deleteEntry(idx)} className="delete-btn">
                                                    üóë Delete
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {view === 'weekly' && weeklyData().map((week, idx) => (
                                        <tr key={idx}>
                                            <td style={{ fontWeight: 600 }}>{week.period}</td>
                                            <td><em>{locationFilter}</em></td>
                                            <td className="text-right">{week.newLeads}</td>
                                            <td className="text-right">{week.activeTrialLeads}</td>
                                            <td className="text-right">{week.texted}</td>
                                            <td className="text-right">{week.called}</td>
                                            <td className="text-right highlight">{week.totalContacted}</td>
                                            <td className="text-right">{week.bookedPhone}</td>
                                            <td className="text-right">{week.bookedText}</td>
                                            <td className="text-right highlight">{week.totalBooked}</td>
                                        </tr>
                                    ))}
                                    {view === 'monthly' && monthlyData().map((month, idx) => (
                                        <tr key={idx}>
                                            <td style={{ fontWeight: 600 }}>{month.period}</td>
                                            <td><em>{locationFilter}</em></td>
                                            <td className="text-right">{month.newLeads}</td>
                                            <td className="text-right">{month.activeTrialLeads}</td>
                                            <td className="text-right">{month.texted}</td>
                                            <td className="text-right">{month.called}</td>
                                            <td className="text-right highlight">{month.totalContacted}</td>
                                            <td className="text-right">{month.bookedPhone}</td>
                                            <td className="text-right">{month.bookedText}</td>
                                            <td className="text-right highlight">{month.totalBooked}</td>
                                        </tr>
                                    ))}
                                    {view === 'yearly' && yearlyData().map((year, idx) => (
                                        <tr key={idx}>
                                            <td style={{ fontWeight: 600 }}>{year.period}</td>
                                            <td><em>{locationFilter}</em></td>
                                            <td className="text-right">{year.newLeads}</td>
                                            <td className="text-right">{year.activeTrialLeads}</td>
                                            <td className="text-right">{year.texted}</td>
                                            <td className="text-right">{year.called}</td>
                                            <td className="text-right highlight">{year.totalContacted}</td>
                                            <td className="text-right">{year.bookedPhone}</td>
                                            <td className="text-right">{year.bookedText}</td>
                                            <td className="text-right highlight">{year.totalBooked}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    <div style={{ textAlign: 'center', padding: '40px 20px', color: '#0077B6', marginTop: '40px' }}>
                        <span style={{ color: '#FF6B35', fontSize: '1.5em' }}>üêæ</span>
                        <strong> SCENTHOUND</strong> - Making dog care routine, affordable, and accessible
                        <span style={{ color: '#FF6B35', fontSize: '1.5em' }}> üêæ</span>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<BowlerTracker />, document.getElementById('root'));
    </script>
</body>
</html>
